<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salla OAuth Callback</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 8px;
      max-width: 500px;
      text-align: center;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-weight: 500;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loading">
      <div class="spinner"></div>
      <h2>Connecting Your Salla Store...</h2>
      <p id="status">Processing authorization...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>
  <script type="module">
    import { 
      exchangeCodeForToken, 
      saveSallaConnection, 
      getSallaStoreInfo 
    } from './salla-oauth.js';
    
    const { Client, Account, Databases } = window.Appwrite;

    // Initialize Appwrite
    const client = new Client()
      .setEndpoint("https://fra.cloud.appwrite.io/v1")
      .setProject("694669640010920ea3f6");

    const account = new Account(client);
    const databases = new Databases(client);

    async function handleCallback() {
      try {
        // Get authorization code from URL
        const params = new URLSearchParams(window.location.search);
        const authCode = params.get('code');
        const error = params.get('error');

        const statusEl = document.getElementById('status');

        // Check for errors
        if (error) {
          throw new Error(`Salla error: ${error}`);
        }

        if (!authCode) {
          throw new Error('No authorization code received');
        }

        statusEl.textContent = 'Exchanging code for token...';

        // Exchange code for token
        const tokenData = await exchangeCodeForToken(authCode);

        statusEl.textContent = 'Getting your store info...';

        // Get store info
        const storeInfo = await getSallaStoreInfo(tokenData.accessToken);

        statusEl.textContent = 'Saving connection...';

        // Get current user
        const user = await account.get();

        // Save connection to Appwrite
        const connection = await saveSallaConnection(databases, user.$id, tokenData);

        // Success!
        document.querySelector('.loading').innerHTML = `
          <h2 style="color: green;">✓ Connected!</h2>
          <p>Your Salla store has been connected successfully.</p>
          <p><strong>Store:</strong> ${storeInfo.data?.name || 'Your Store'}</p>
          <p style="margin-top: 20px; font-size: 14px; color: #666;">Redirecting to dashboard...</p>
        `;

        // Redirect to dashboard after 2 seconds
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        
        const statusEl = document.getElementById('status');
        statusEl.textContent = `❌ ${error.message}`;
        
        document.querySelector('.loading').innerHTML = `
          <h2 style="color: red;">Connection Failed</h2>
          <p id="error-msg">${error.message}</p>
          <p style="margin-top: 20px;">
            <a href="/" style="color: #1a73e8; text-decoration: none;">← Back to Dashboard</a>
          </p>
        `;
      }
    }

    // Run when page loads
    handleCallback();
  </script>
</body>
</html>
